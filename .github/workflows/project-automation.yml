name: Project Automation

on:
  issues:
    types: [opened, edited, closed, reopened, assigned]
  pull_request:
    types: [opened, edited, closed, reopened, synchronize]
  pull_request_review:
    types: [submitted, edited]

jobs:
  triage:
    runs-on: ubuntu-latest
    steps:
      - name: Add triage label to new issues
        if: github.event_name == 'issues' && github.event.action == 'opened'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.addLabels({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: ['status::triage']
            });

      - name: Auto-assign issues
        if: github.event_name == 'issues' && github.event.action == 'opened'
        uses: pozetroninc/github-action-get-latest-release@v0.7.0
        continue-on-error: true
        with:
          owner: ${{ github.repository_owner }}
          repo: ${{ github.event.repository.name }}

  pr-checks:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: Check PR title format
        uses: amannn/action-semantic-pull-request@v5
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          types: |
            feat
            fix
            docs
            style
            refactor
            perf
            test
            build
            ci
            chore
            revert
          requireScope: false

      - name: Size labeler
        uses: codelytv/pr-size-labeler@v1
        with:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          xs_label: 'size::xs'
          xs_max_size: 50
          s_label: 'size::s'
          s_max_size: 100
          m_label: 'size::m'
          m_max_size: 500
          l_label: 'size::l'
          l_max_size: 1000
          xl_label: 'size::xl'

  stale-check:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' && github.event.action == 'synchronize'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check if PR is stale
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const lastUpdate = new Date(pr.updated_at);
            const now = new Date();
            const daysStale = (now - lastUpdate) / (1000 * 60 * 60 * 24);
            
            if (daysStale > 7) {
              github.rest.issues.addLabels({
                issue_number: pr.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                labels: ['status::stale']
              });
            }
