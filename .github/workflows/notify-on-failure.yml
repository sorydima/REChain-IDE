name: Notify on Failure

on:
  workflow_run:
    workflows: 
      - "CI"
      - "Security Scan"
      - "Automated Testing"
    types: [completed]
    branches: [main, develop]

jobs:
  notify:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'failure' }}
    steps:
      - name: Send Discord notification
        if: ${{ secrets.DISCORD_WEBHOOK_URL != '' }}
        uses: Ilshidur/action-discord@master
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
        with:
          args: |
            ðŸš¨ **Workflow Failed** ðŸš¨
            
            Repository: ${{ github.repository }}
            Workflow: ${{ github.event.workflow_run.name }}
            Branch: ${{ github.event.workflow_run.head_branch }}
            Commit: ${{ github.event.workflow_run.head_sha }}
            
            [View Run](${{ github.event.workflow_run.html_url }})

      - name: Create issue for recurring failures
        uses: actions/github-script@v7
        with:
          script: |
            const workflowName = context.payload.workflow_run.name;
            const branch = context.payload.workflow_run.head_branch;
            
            // Search for existing open issues about this workflow
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: 'ci-failure',
              state: 'open'
            });
            
            const existingIssue = issues.data.find(i => 
              i.title.includes(`CI Failure: ${workflowName}`)
            );
            
            if (!existingIssue) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `CI Failure: ${workflowName} on ${branch}`,
                body: `The workflow **${workflowName}** failed on branch **${branch}**.\n\n[View Run](${context.payload.workflow_run.html_url})`,
                labels: ['ci-failure', 'priority::high']
              });
            }
