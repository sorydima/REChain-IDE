# Test stage jobs

test:unit:
  stage: test
  needs:
    - job: build:go
      optional: true
  script:
    - cd rechain-ide
    - go test -v -race -coverprofile=../coverage.out ./...
    - go tool cover -html=../coverage.out -o ../coverage.html
  artifacts:
    paths:
      - coverage.out
      - coverage.html
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage.xml
    expire_in: 1 week
  coverage: '/total:\s*\(statements\)\s*(\d+\.?\d*)%/'
  rules:
    - if: $CI_COMMIT_BRANCH
    - if: $CI_MERGE_REQUEST_IID
    - if: $CI_COMMIT_TAG

test:benchmark:
  stage: test
  script:
    - cd rechain-ide
    - go test -bench=. -benchmem ./... | tee benchmark.log
  artifacts:
    paths:
      - rechain-ide/benchmark.log
    expire_in: 1 week
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_COMMIT_TAG

test:lint:
  stage: test
  image: golangci/golangci-lint:v1.55
  script:
    - cd rechain-ide
    - golangci-lint run --out-format=code-climate | tee gl-code-quality-report.json || true
  artifacts:
    reports:
      codequality: gl-code-quality-report.json
    paths:
      - gl-code-quality-report.json
    expire_in: 1 week
    when: always
  allow_failure: true
  rules:
    - if: $CI_COMMIT_BRANCH
    - if: $CI_MERGE_REQUEST_IID

test:vet:
  stage: test
  script:
    - cd rechain-ide
    - go vet ./...
  rules:
    - if: $CI_COMMIT_BRANCH
    - if: $CI_MERGE_REQUEST_IID

test:format:
  stage: test
  script:
    - cd rechain-ide
    - |
      fmt_files=$(gofmt -l .)
      if [ -n "$fmt_files" ]; then
        echo "The following files need formatting:"
        echo "$fmt_files"
        exit 1
      fi
  rules:
    - if: $CI_COMMIT_BRANCH
    - if: $CI_MERGE_REQUEST_IID
