# Release jobs

release:prepare:
  stage: release
  image: registry.gitlab.com/gitlab-org/release-cli:latest
  script:
    - echo "Preparing release artifacts"
    - echo "Version $CI_COMMIT_TAG"
  artifacts:
    paths:
      - bin/
      - CHANGELOG.md
    expire_in: 1 month
  rules:
    - if: $CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+$/

create:release:
  stage: release
  image: registry.gitlab.com/gitlab-org/release-cli:latest
  script:
    - |
      release-cli create --name "Release $CI_COMMIT_TAG" \
        --tag-name $CI_COMMIT_TAG \
        --description "Release notes for $CI_COMMIT_TAG" \
        --assets-link "{\"name\":\"rechain-ide\",\"url\":\"$CI_JOB_URL/artifacts/raw/bin/rechain-ide\"}" \
        --assets-link "{\"name\":\"rechain-cli\",\"url\":\"$CI_JOB_URL/artifacts/raw/bin/rechain-cli\"}"
  rules:
    - if: $CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+$/
  dependencies:
    - release:prepare
  needs:
    - job: release:prepare
    - job: deploy:production
      optional: true

generate:changelog:
  stage: release
  image: node:18
  before_script:
    - npm install -g conventional-changelog-cli
  script:
    - conventional-changelog -p angular -i CHANGELOG.md -s
    - git config user.email "gitlab-ci@rechain-ide.local"
    - git config user.name "GitLab CI"
    - git add CHANGELOG.md
    - git commit -m "docs: update changelog [skip ci]"
    - git push origin $CI_COMMIT_BRANCH
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
  when: manual
  allow_failure: true
